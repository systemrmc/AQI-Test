<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>One Lodha Place | Air Quality Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="420"> 
    <link href="https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --gold: #9e801b;
            --text-greyish: #777777; 
            --glass-bg: rgba(255, 255, 255, 0.35);
            --glass-border: rgba(255, 255, 255, 0.4);
            --faint-labelcard: rgba(68, 68, 68, 0.7);
            --faint-label: rgba(68, 68, 68, 0.8);
            
            --visible-grey: rgba(180, 180, 180, 0.5);
        }
        
        body, html { 
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            font-family: 'Jost', sans-serif;
            background: url('background.jpg') no-repeat center center fixed; 
            background-size: cover;
            display: flex; flex-direction: column; align-items: center;
            color: var(--text-greyish);
            overflow: hidden;
        }

        .dashboard-wrapper {
            width: 100vw; height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            justify-content: space-between; 
            padding: 6vh 0; box-sizing: border-box;
        }

        .header-section {
            display: flex; flex-direction: column;
            gap: 4vh; align-items: center;
        }

        .header-top, .footer-text { 
            font-size: 2.5vh; font-weight: 500;
            text-transform: uppercase; text-align: center;
        }

        .main-headline { 
            font-size: 4vh; font-weight: 400; 
            text-transform: uppercase; text-align: center;
            word-spacing: 0.2vw; letter-spacing: 0.2vw;
            margin: 0;
        }
        #status-text { font-weight: 600; }

        .card-container { 
            display: flex; flex-direction: row; gap: 5vw; 
            justify-content: center; align-items: center;
            width: 100%; flex-grow: 1; 
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 2.5vh; 
            width: 50vh; height: 50vh;
            display: flex; flex-direction: column; 
            justify-content: space-around; align-items: center; 
            padding: 3vh 2vw;
            border: 0.2vh solid var(--glass-border);
            box-sizing: border-box;
            box-shadow: 0 4vh 8vh rgba(0,0,0,0.1);
        }

        .card-label { font-size: 3vh; text-transform: uppercase; font-weight: 400; }
        .card-label b { font-weight: 600; color: var(--faint-labelcard); }

        .aqi-value { font-size: 15vh; font-weight: 200; color: var(--gold); line-height: 0.7; margin: 0; }

        .metrics-box {
            display: flex; width: 100%; 
            border: 0.25vh solid var(--visible-grey); 
            border-radius: 2vh; padding: 2.5vh 0;
            background: rgba(255,255,255,0.05);
        }

        .metric-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .metric-label { font-size: 2.5vh; text-transform: uppercase; color: var(--faint-label); margin-bottom: 0.2vh; }
        .metric-val { font-size: 3vh; font-weight: 500; color: var(--gold); white-space: nowrap; }
        .metric-unit { font-size: 1em; margin-left: 0.5vh; }

        .footer-container { display: flex; align-items: center; justify-content: center; flex-grow: 0.2; }
    </style>
</head>
<body>

    <div class="dashboard-wrapper">
        <div class="header-section">
            <div class="header-top">Live AQI</div>
            <div class="main-headline">Indoor Air Quality is <b id="status-text">Detecting...</b></div>
        </div>

        <div class="card-container">
            <div class="glass-card">
                <div class="card-label"><b>Internal</b> AQI</div>
                <div class="aqi-value" id="in-aqi">--</div>
                <div class="metrics-box">
                    <div class="metric-item">
                        <span class="metric-label">PM2.5</span>
                        <span class="metric-val" id="in-pm25">--</span>
                    </div>
                    <div class="metric-item" style="border-left: 0.25vh solid var(--visible-grey);">
                        <span class="metric-label">PM10</span>
                        <span class="metric-val" id="in-pm10">--</span>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <div class="card-label"><b>External</b> AQI</div>
                <div class="aqi-value" id="out-aqi">--</div>
                <div class="metrics-box">
                    <div class="metric-item">
                        <span class="metric-label">PM2.5</span>
                        <span class="metric-val" id="out-pm25">--</span>
                    </div>
                    <div class="metric-item" style="border-left: 0.25vh solid var(--visible-grey);">
                        <span class="metric-label">PM10</span>
                        <span class="metric-val" id="out-pm10">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-container">
            <div class="footer-text">One Lodha Place, Mumbai</div>
        </div>
    </div>

    <script>
        const K_KEY = 'nomjPNZHYkGzzP5YIJePqI2cUON67v1pj9JPXb8BpcgnC5VX';
        const GOOGLE_KEY = 'AIzaSyD-sKAUFhaCGFENHqjlyrQfhbgOplhxy-Q'; 
        const LAT = 19.0000, LON = 72.8200;
        const DEVICE_IDS = ['caf4632a-98dd-47f3-bfd7-6b54ba5a6886', 'c13d22a5-318b-459f-92b6-cb1a8182083a', '0fcb68a7-d014-4c64-afb5-911c3f697879', 'c1dd9ba1-d323-4c20-9eb0-88b5908c60d2', 'a74bbddc-8f27-43de-8672-90a80d0cd3a1', '8fc8d082-1a34-4950-b8d0-d0d68be4a6ef', '796ebfee-564a-4361-b7d1-90f86c9297ed', 'f05a413c-a488-427c-a12a-dc22851d9942'];                                                                           

        function calcAQI(pm) {
            if (pm <= 30) return Math.round(pm * 50 / 30);
            if (pm <= 60) return Math.round(50 + (pm - 30) * (50 / 30));
            if (pm <= 90) return Math.round(100 + (pm - 60) * (100 / 30));
            if (pm <= 120) return Math.round(200 + (pm - 90) * (100 / 30));
            if (pm <= 250) return Math.round(300 + (pm - 120) * (100 / 130));
            return 500;
        }

        async function updateData() {
                try {
                // INTERNAL (Average logic with device availability check)
                const fetches = DEVICE_IDS.map(id => 
                    fetch(`https://api.kaiterra.com/v1/devices/${id}/top?key=${K_KEY}`)
                    .then(r => r.ok ? r.json() : null)
                    .catch(() => null)
                );
                
                const results = await Promise.allSettled(fetches);
                let validPM25 = [], validPM10 = [];
 
                results.forEach(res => {
                    if (res.status === 'fulfilled' && res.value && res.value.data) {
                       try {
                            const p25 = res.value.data.find(x => x.param === 'rpm25c').points[0].value;
                            const p10 = res.value.data.find(x => x.param === 'rpm10c').points[0].value;
                            if (p25 !== undefined && p25 !== null) validPM25.push(p25);
                            if (p10 !== undefined && p10 !== null) validPM10.push(p10);
                        } catch(e) {}
                    }
                });
 
                if (validPM25.length > 0) {
                    // Calculating Average instead of Min
                    const avg25 = validPM25.reduce((a, b) => a + b, 0) / validPM25.length;
                    const avg10 = validPM10.reduce((a, b) => a + b, 0) / validPM10.length;
                    
                    const aqi = calcAQI(avg25);
                    document.getElementById('in-aqi').innerText = aqi;
                    document.getElementById('in-pm25').innerHTML = Math.round(avg25) + '<span class="metric-unit">µg/m³</span>';
                    document.getElementById('in-pm10').innerHTML = Math.round(avg10) + '<span class="metric-unit">µg/m³</span>';
                    
                    const st = document.getElementById('status-text');
                    st.innerText = aqi <= 15 ? "PRISTINE" : aqi <= 30 ? "EXCEPTIONAL" : aqi <= 45 ? "EXCELLENT" : aqi <= 60 ? "VERY GOOD" : "GOOD";

}
                // External Google API (Corrected to 'ind_cpcb')
                const gRes = await fetch(`https://airquality.googleapis.com/v1/currentConditions:lookup?key=${GOOGLE_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        location: { latitude: LAT, longitude: LON },
                        extraComputations: ["LOCAL_AQI", "POLLUTANT_CONCENTRATION"]
                    })
                });
                const gData = await gRes.json();
                if (gData && gData.indexes) {
                    // UPDATED: Now looks for 'ind_cpcb'
                    const localIdx = gData.indexes.find(i => i.code === 'ind_cpcb') || gData.indexes[0];
                    document.getElementById('out-aqi').innerText = localIdx.aqi;
                    
                    const pm25 = gData.pollutants.find(p => p.code === 'pm25');
                    const pm10 = gData.pollutants.find(p => p.code === 'pm10');
                    if (pm25) document.getElementById('out-pm25').innerHTML = Math.round(pm25.concentration.value) + '<span class="metric-unit">µg/m³</span>';
                    if (pm10) document.getElementById('out-pm10').innerHTML = Math.round(pm10.concentration.value) + '<span class="metric-unit">µg/m³</span>';
                }
            } catch (e) { console.error(e); }
        }
        updateData();
        setInterval(updateData, 300000); 
    </script>
</body>
</html>
